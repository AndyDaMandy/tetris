<html>

<head>
    <title>Tetris</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HDRY5R79EL"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-HDRY5R79EL');
    </script>
    <style type="text/css">
        canvas {
            border: 1px black solid;
        }
    </style>
</head>

<body>
    <canvas id="render_canvas" width="100" height="200"></canvas>
    <div style="font-family: 'Courier New'" id="render_text"></div>
    <p style="font-family: 'Courier New'"><a href="https://github.com/kevinAlbs/tetris">See Source</a></p>
    <script src="game.js"></script>
    <script src="tests.js"></script>
    <script>
        window.onload = main;

        const cnv = document.querySelector("#render_canvas")
        const ctx = cnv.getContext("2d");
        const kCanvasWidth = cnv.width;
        const kCanvasHeight = cnv.height;
        const kCellWidth = 10;
        function do_render(game) {
            const grid = game.get_grid();
            ctx.clearRect(0, 0, kCanvasWidth, kCanvasHeight);
            for (let i = 0; i < grid.nrows(); i++) {
                for (let j = 0; j < grid.ncols(); j++) {
                    if (grid.get(i, j).filled) {
                        ctx.fillStyle = "#000";
                        ctx.fillRect(j * kCellWidth, i * kCellWidth, kCellWidth, kCellWidth);
                    }
                }
            }
            const tetrimino = game.get_tetrimino();
            if (tetrimino) {
                const coords = tetrimino.get_coordinates();
                for (let idx = 0; idx < coords.length; idx++) {
                    const pair = coords[idx];
                    ctx.fillStyle = "#666";
                    ctx.fillRect(pair.j * kCellWidth, pair.i * kCellWidth, kCellWidth, kCellWidth);
                }
            }

            const ghost_piece = game.get_ghost_piece();
            if (ghost_piece) {
                const coords = ghost_piece.get_coordinates();
                for (let idx = 0; idx < coords.length; idx++) {
                    const pair = coords[idx];
                    ctx.fillStyle = "#EEE";
                    ctx.fillRect(pair.j * kCellWidth, pair.i * kCellWidth, kCellWidth, kCellWidth);
                }
            }
        }

        let copy_debug_info = null;
        function main() {
            const game = game_make({ grid: { use_test_grid: false }, enable_spawn: true, show_ghost_piece: true });
            game.register_event_listeners();
            game.loop({
                render_callback: function () { do_render(game); },
                render_text_element: document.querySelector("#render_text")
            });
            copy_debug_info = function () {
                console.log();
                const debug_info = game.get_debug_info();
                for (let i = 0; i < debug_info.last_n_renders.length; i++) {
                    debug_info.last_n_renders[i] = debug_info.last_n_renders[i].split("\n");
                }
                copy(JSON.stringify(debug_info, null, "    "));
                console.log("Debug info is copied. Paste into a file. Upload the file to a GitHub issue to report a bug: https://github.com/kevinAlbs/tetris/issues");
            }
        }
        console.log("To report a bug, copy debug info with: `copy_debug_info()`");
    </script>
</body>

</html>